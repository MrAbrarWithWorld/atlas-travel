<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<title>ATLAS â€” AI Travel Intelligence</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
html,body,#root{height:100%;}
body{background:#12100d;color:#ede5d5;font-family:'DM Sans',sans-serif;-webkit-font-smoothing:antialiased;}
::-webkit-scrollbar{width:2px;}
::-webkit-scrollbar-thumb{background:rgba(201,169,110,0.2);}
@keyframes pulse{0%,80%,100%{opacity:.2;transform:scale(.6)}40%{opacity:1;transform:scale(1)}}
@keyframes up{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes ripple{0%{transform:scale(1);opacity:0.8}100%{transform:scale(2.5);opacity:0}}
@keyframes glow{0%,100%{box-shadow:0 0 8px rgba(201,169,110,0.3)}50%{box-shadow:0 0 16px rgba(201,169,110,0.6)}}
.msg{animation:up 0.28s ease;}
textarea{font-family:'DM Sans',sans-serif;-webkit-appearance:none;}
textarea::placeholder{color:#3d3528;}
textarea:focus{outline:none;}
button{-webkit-tap-highlight-color:transparent;}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const PERSONA = `You are ATLAS â€” the world's most sophisticated AI travel intelligence.

LANGUAGE: Detect user language instantly. Respond ENTIRELY in that language.
CURRENCY: Use exactly the currency the user mentions.

PASSPORT & VISA â€” CRITICAL:
- Always ask which passport if not mentioned.
- Never assume strong passport.
- Handle: Bangladesh, Pakistan, India, Nigeria, RTD, Dual citizenship.
- For RTD: ask which country issued it, explain visa requirements specifically.

ROUTING RULES:
- Always find most efficient route. Direct over connecting always.
- Never repeat same flight segment twice.
- Always compare direct vs connecting and show savings.

Structure every plan:
## âœˆï¸ FLIGHTS â€” routing analysis, direct vs connecting, savings
## ðŸ›‚ VISA â€” specific to passport type, where to apply, cost, time
## ðŸ¨ STAY â€” specific hotel, price per night, booking platform
## ðŸ½ï¸ EAT â€” daily budget, restaurants with prices
## ðŸš‡ MOVE â€” airport transfer, city transport, daily cost
## ðŸ—“ï¸ DAY BY DAY â€” complete EVERY day, never stop early
## ðŸ’° TOTAL COST â€” itemized breakdown, savings shown
## ðŸŽ¬ CONTENT SPOTS â€” filming locations, golden hour times
## ðŸ“‹ ESSENTIALS â€” visa, SIM, ATM, safety, weather

CRITICAL: Never truncate. Complete every day. Always cheapest routing.`;

const STORAGE_KEY = 'atlas_v3';
const { useState, useRef, useEffect } = React;

function saveChat(msgs, hist) {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify({msgs, hist, t: Date.now()})); } catch(e){}
}
function loadChat() {
  try {
    const d = JSON.parse(localStorage.getItem(STORAGE_KEY)||'null');
    if(!d || Date.now()-d.t > 24*60*60*1000) return null;
    return d;
  } catch(e){return null;}
}
const defaultHist = [
  {role:"user",content:"Who are you?"},
  {role:"assistant",content:PERSONA+"\n\nI am ATLAS. Tell me where you want to go."}
];

function Modal({hours, plansLeft, onClose}) {
  const isPlan = plansLeft !== undefined;
  return React.createElement("div",{style:{position:"fixed",inset:0,background:"rgba(8,7,5,0.95)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:100,animation:"fadeIn 0.25s ease",padding:"1rem"}},
    React.createElement("div",{style:{width:"100%",maxWidth:320,padding:"2.5rem 1.75rem",textAlign:"center",border:"1px solid rgba(201,169,110,0.18)",borderRadius:14,background:"#1a1710"}},
      React.createElement("div",{style:{fontFamily:"'Cormorant Garamond',serif",fontSize:"1.8rem",color:"rgba(201,169,110,0.2)",letterSpacing:"0.2em",marginBottom:"1.5rem"}},"ATLAS"),
      React.createElement("div",{style:{fontSize:"1rem",color:"#d4aa6e",marginBottom:"0.75rem",fontFamily:"'Cormorant Garamond',serif"}},isPlan?"Plan limit reached":"Session complete"),
      React.createElement("p",{style:{fontSize:"0.78rem",color:"#7a7060",lineHeight:1.85,marginBottom:"1.25rem"}},
        isPlan?`You've created 2 travel plans. You still have ${plansLeft} tokens â€” ask questions about your plans!`
              :`Come back in ${hours} hour${hours>1?'s':''} for a fresh session.`
      ),
      React.createElement("div",{style:{background:"rgba(201,169,110,0.05)",border:"1px solid rgba(201,169,110,0.1)",borderRadius:8,padding:"0.875rem",marginBottom:"1.25rem"}},
        React.createElement("p",{style:{fontSize:"0.65rem",color:"#c9a96e",letterSpacing:"0.1em",textTransform:"uppercase",marginBottom:"0.35rem"}},"Want unlimited access?"),
        React.createElement("p",{style:{fontSize:"0.75rem",color:"#6a6050",lineHeight:1.7}},"Upgrade to ATLAS Pro for unlimited plans.")
      ),
      React.createElement("button",{onClick:onClose,style:{width:"100%",padding:"0.75rem",background:"none",border:"1px solid rgba(201,169,110,0.2)",borderRadius:8,color:"#c9a96e",cursor:"pointer",fontSize:"0.7rem",letterSpacing:"0.1em",textTransform:"uppercase"}},"Close")
    )
  );
}

function Prose({text}) {
  return React.createElement("div",null,text.split("\n").map((line,i)=>{
    if(!line.trim()) return React.createElement("div",{key:i,style:{height:"0.35rem"}});
    if(line.startsWith("## ")) return React.createElement("div",{key:i,style:{fontSize:"0.68rem",fontWeight:600,color:"#c9a96e",letterSpacing:"0.14em",textTransform:"uppercase",margin:"1rem 0 0.35rem",paddingBottom:"0.25rem",borderBottom:"1px solid rgba(201,169,110,0.12)"}},line.slice(3));
    if(/^\*\*Day\s+\d+/.test(line)||/^###/.test(line)) return React.createElement("div",{key:i,style:{fontFamily:"'Cormorant Garamond',serif",fontSize:"0.9rem",fontWeight:700,color:"#ede5d5",margin:"0.65rem 0 0.1rem"}},line.replace(/^###\s*/,"").replace(/\*\*/g,""));
    if(line.startsWith("- ")||line.startsWith("* ")) return React.createElement("div",{key:i,style:{display:"flex",gap:"0.4rem",margin:"0.12rem 0",fontSize:"0.81rem",color:"#a8a090"}},React.createElement("span",{style:{color:"#c9a96e",fontSize:"0.48rem",marginTop:"5px",flexShrink:0}},"â—†"),React.createElement("span",null,line.slice(2)));
    const parts=[]; let rem=line,k=0;
    while(rem){const m=rem.match(/\*\*(.+?)\*\*/);if(!m){parts.push(React.createElement("span",{key:k++},rem));break;}const idx=rem.indexOf(m[0]);if(idx>0)parts.push(React.createElement("span",{key:k++},rem.slice(0,idx)));parts.push(React.createElement("span",{key:k++,style:{color:"#ddd5c5",fontWeight:600}},m[1]));rem=rem.slice(idx+m[0].length);}
    return React.createElement("p",{key:i,style:{margin:"0.08rem 0",fontSize:"0.81rem",color:"#a8a090",lineHeight:1.85}},...parts);
  }));
}

function Dots() {
  return React.createElement("div",{style:{display:"flex",gap:6}},[0,1,2].map(i=>React.createElement("span",{key:i,style:{width:5,height:5,borderRadius:"50%",background:"#c9a96e",display:"inline-block",animation:`pulse 1.4s ${i*0.2}s ease-in-out infinite`}})));
}

function MicButton({listening, onClick}) {
  return React.createElement("button",{
    onClick,
    style:{
      flexShrink:0,width:40,height:40,borderRadius:"50%",
      border:`1.5px solid ${listening?"#c9a96e":"rgba(201,169,110,0.2)"}`,
      background:listening?"rgba(201,169,110,0.1)":"rgba(201,169,110,0.03)",
      cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",
      transition:"all 0.25s",position:"relative",
      animation:listening?"glow 1.5s ease-in-out infinite":"none"
    }
  },
    listening&&React.createElement("span",{style:{position:"absolute",inset:-4,borderRadius:"50%",border:"1px solid rgba(201,169,110,0.25)",animation:"ripple 1.2s ease-out infinite"}}),
    listening&&React.createElement("span",{style:{position:"absolute",inset:-8,borderRadius:"50%",border:"1px solid rgba(201,169,110,0.1)",animation:"ripple 1.2s 0.4s ease-out infinite"}}),
    React.createElement("svg",{width:"17",height:"17",viewBox:"0 0 24 24",fill:"none",stroke:listening?"#c9a96e":"#7a6a50",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round"},
      React.createElement("rect",{x:"9",y:"2",width:"6",height:"12",rx:"3",fill:listening?"rgba(201,169,110,0.15)":"none"}),
      React.createElement("path",{d:"M5 10a7 7 0 0 0 14 0"}),
      React.createElement("line",{x1:"12",y1:"19",x2:"12",y2:"22"}),
      React.createElement("line",{x1:"8",y1:"22",x2:"16",y2:"22"})
    )
  );
}

function App() {
  const saved = loadChat();
  const [msgs, setMsgs] = useState(saved?.msgs||[]);
  const [draft, setDraft] = useState("");
  const [busy, setBusy] = useState(false);
  const [modal, setModal] = useState(null);
  const [listening, setListening] = useState(false);
  const [speaking, setSpeaking] = useState(false);
  const hist = useRef(saved?.hist||[...defaultHist]);
  const endRef = useRef(null);
  const taRef = useRef(null);
  const recognitionRef = useRef(null);

  useEffect(()=>{endRef.current?.scrollIntoView({behavior:"smooth"});},[msgs,busy]);

  useEffect(()=>{
    const SR = window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR) return;
    const r = new SR();
    r.continuous = false;
    r.interimResults = true;
    r.onresult = e => {
      const t = Array.from(e.results).map(r=>r[0].transcript).join('');
      setDraft(t);
      if(e.results[e.results.length-1].isFinal) setListening(false);
    };
    r.onend = ()=>setListening(false);
    r.onerror = ()=>setListening(false);
    recognitionRef.current = r;
  },[]);

  function toggleVoice() {
    if(!recognitionRef.current){alert("Voice not supported. Use Chrome or Safari.");return;}
    if(listening){recognitionRef.current.stop();setListening(false);}
    else{if(window.speechSynthesis)window.speechSynthesis.cancel();recognitionRef.current.start();setListening(true);}
  }

  function toggleSpeak(text) {
    if(!window.speechSynthesis) return;
    if(speaking){window.speechSynthesis.cancel();setSpeaking(false);return;}
    setSpeaking(true);
    const clean = text.replace(/##.*?\n/g,'').replace(/\*\*/g,'').replace(/[â—†â€¢]/g,'').slice(0,1000);
    const u = new SpeechSynthesisUtterance(clean);
    u.rate=0.95;
    u.onend=()=>setSpeaking(false);
    u.onerror=()=>setSpeaking(false);
    window.speechSynthesis.speak(u);
  }

  async function send(txt) {
    const t=(txt??draft).trim();
    if(!t||busy) return;
    if(window.speechSynthesis)window.speechSynthesis.cancel();
    setSpeaking(false);
    setDraft("");
    if(taRef.current)taRef.current.style.height="auto";
    const newMsgs=[...msgs,{id:Date.now(),from:"user",text:t}];
    setMsgs(newMsgs);
    setBusy(true);
    hist.current=[...hist.current,{role:"user",content:t}];
    try {
      const res = await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:hist.current.slice(-16)})});
      if(res.status===429){
        const data=await res.json();
        const msg=data.error?.message||"";
        if(msg.startsWith("LIMIT_REACHED|"))setModal({type:"limit",hours:parseInt(msg.split("|")[1])||6});
        else if(msg.startsWith("PLAN_LIMIT|")){const p=msg.split("|");setModal({type:"plan",hours:parseInt(p[1])||6,left:parseInt(p[2])||0});}
        setBusy(false);return;
      }
      if(!res.ok)throw new Error(`Error ${res.status}`);
      const data=await res.json();
      if(data.error)throw new Error(data.error.message||"Error");
      const reply=data.content?.[0]?.text;
      if(!reply)throw new Error("No response");
      hist.current=[...hist.current,{role:"assistant",content:reply}];
      const final=[...newMsgs,{id:Date.now()+1,from:"ai",text:reply}];
      setMsgs(final);
      saveChat(final,hist.current);
    } catch(e){
      setMsgs(m=>[...m,{id:Date.now()+1,from:"ai",text:"Something went wrong. Please try again."}]);
    }
    setBusy(false);
  }

  function reset(){
    if(!confirm("Start a new journey?"))return;
    setMsgs([]);setDraft("");
    if(window.speechSynthesis)window.speechSynthesis.cancel();
    hist.current=[...defaultHist];
    localStorage.removeItem(STORAGE_KEY);
  }

  const hasSpeech=!!window.speechSynthesis;
  const hasVoice=!!(window.SpeechRecognition||window.webkitSpeechRecognition);

  return React.createElement("div",{style:{height:"100vh",display:"flex",flexDirection:"column",background:"#12100d",overflow:"hidden"}},
    modal&&React.createElement(Modal,{hours:modal.hours,plansLeft:modal.type==="plan"?modal.left:undefined,onClose:()=>setModal(null)}),
    React.createElement("div",{style:{padding:"1rem 1.5rem",display:"flex",alignItems:"center",justifyContent:"space-between",flexShrink:0,borderBottom:"1px solid rgba(201,169,110,0.07)"}},
      React.createElement("div",{style:{fontFamily:"'Cormorant Garamond',serif",fontSize:"1.2rem",fontWeight:300,letterSpacing:"0.3em",color:"#c9a96e",textTransform:"uppercase"}},"Atlas"),
      msgs.length>0&&React.createElement("button",{onClick:reset,style:{background:"none",border:"none",color:"#4a4030",cursor:"pointer",fontSize:"0.6rem",letterSpacing:"0.12em",textTransform:"uppercase",fontFamily:"'DM Sans',sans-serif"}},"New journey")
    ),
    React.createElement("div",{style:{flex:1,overflowY:"auto",WebkitOverflowScrolling:"touch",display:"flex",flexDirection:"column"}},
      msgs.length===0&&React.createElement("div",{style:{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"2rem",textAlign:"center"}},
        React.createElement("div",{style:{fontFamily:"'Cormorant Garamond',serif",fontSize:"2.4rem",fontWeight:300,color:"rgba(201,169,110,0.1)",letterSpacing:"0.25em",textTransform:"uppercase",marginBottom:"1.5rem"}},"ATLAS"),
        React.createElement("p",{style:{fontSize:"0.8rem",color:"#3d3528",lineHeight:2,maxWidth:"220px"}},"Tell me where you want to go.",React.createElement("br"),"Any language. Any budget. Any dream."),
        hasVoice&&React.createElement("div",{style:{marginTop:"1.75rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#2e2518",fontSize:"0.58rem",letterSpacing:"0.1em",textTransform:"uppercase"}},
          React.createElement("svg",{width:"11",height:"11",viewBox:"0 0 24 24",fill:"none",stroke:"#3a2e1e",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"},
            React.createElement("rect",{x:"9",y:"2",width:"6",height:"12",rx:"3"}),
            React.createElement("path",{d:"M5 10a7 7 0 0 0 14 0"}),
            React.createElement("line",{x1:"12",y1:"19",x2:"12",y2:"22"}),
            React.createElement("line",{x1:"8",y1:"22",x2:"16",y2:"22"})
          ),
          "Voice enabled"
        )
      ),
      msgs.length>0&&React.createElement("div",{style:{padding:"1.25rem 1.5rem",display:"flex",flexDirection:"column",gap:"1.35rem"}},
        ...msgs.map(msg=>React.createElement("div",{key:msg.id,className:"msg",style:{display:"flex",flexDirection:msg.from==="user"?"row-reverse":"row",gap:"0.75rem",alignItems:"flex-start"}},
          React.createElement("div",{style:{flexShrink:0,width:22,height:22,borderRadius:"50%",border:`1px solid ${msg.from==="user"?"rgba(201,169,110,0.15)":"rgba(201,169,110,0.35)"}`,display:"flex",alignItems:"center",justifyContent:"center",marginTop:2}},
            React.createElement("span",{style:{fontSize:"0.46rem",color:"#c9a96e"}},msg.from==="user"?"U":"A")
          ),
          React.createElement("div",{style:{maxWidth:"88%"}},
            msg.from==="user"
              ? React.createElement("p",{style:{fontSize:"0.84rem",color:"#d5cdc0",lineHeight:1.75,padding:"0.6rem 0.9rem",background:"rgba(201,169,110,0.04)",border:"1px solid rgba(201,169,110,0.09)",borderRadius:10}},msg.text)
              : React.createElement("div",null,
                  React.createElement(Prose,{text:msg.text}),
                  hasSpeech&&React.createElement("button",{onClick:()=>toggleSpeak(msg.text),style:{marginTop:"0.6rem",background:"none",border:"1px solid rgba(201,169,110,0.12)",borderRadius:5,padding:"0.28rem 0.7rem",color:speaking?"#c9a96e":"#4a4030",cursor:"pointer",fontSize:"0.58rem",letterSpacing:"0.08em",textTransform:"uppercase",fontFamily:"'DM Sans',sans-serif"}},speaking?"â¹ Stop":"ðŸ”Š Listen")
                )
          )
        )),
        busy&&React.createElement("div",{className:"msg",style:{display:"flex",gap:"0.75rem",alignItems:"center"}},
          React.createElement("div",{style:{width:22,height:22,borderRadius:"50%",border:"1px solid rgba(201,169,110,0.35)",display:"flex",alignItems:"center",justifyContent:"center"}},React.createElement("span",{style:{fontSize:"0.46rem",color:"#c9a96e"}},"A")),
          React.createElement(Dots)
        ),
        React.createElement("div",{ref:endRef,style:{height:"0.5rem"}})
      )
    ),
    React.createElement("div",{style:{padding:"0 1.5rem 1.35rem",flexShrink:0}},
      React.createElement("div",{style:{height:"1px",background:"rgba(201,169,110,0.1)",marginBottom:"1rem"}}),
      React.createElement("div",{style:{display:"flex",gap:"0.65rem",alignItems:"flex-end"}},
        hasVoice&&React.createElement(MicButton,{listening,onClick:toggleVoice}),
        React.createElement("textarea",{ref:taRef,value:draft,onChange:e=>setDraft(e.target.value),onKeyDown:e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();send();}},onInput:e=>{e.target.style.height="auto";e.target.style.height=Math.min(e.target.scrollHeight,100)+"px";},placeholder:listening?"Listening...":"Where would you like to go?",disabled:busy||listening,rows:1,style:{flex:1,background:"none",border:"none",outline:"none",color:listening?"#c9a96e":"#d5cdc0",fontSize:"0.88rem",resize:"none",lineHeight:1.7,maxHeight:100,overflowY:"auto",paddingTop:"0.15rem"}}),
        React.createElement("button",{onClick:()=>send(),disabled:!draft.trim()||busy,style:{flexShrink:0,background:draft.trim()&&!busy?"rgba(201,169,110,0.08)":"none",border:`1.5px solid ${draft.trim()&&!busy?"rgba(201,169,110,0.35)":"rgba(201,169,110,0.08)"}`,borderRadius:8,width:40,height:40,cursor:draft.trim()&&!busy?"pointer":"default",color:draft.trim()&&!busy?"#c9a96e":"#2e2820",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"1rem",transition:"all 0.2s"}},busy?"Â·":"â†‘")
      ),
      React.createElement("div",{style:{marginTop:"0.55rem",fontSize:"0.54rem",color:"#252015",letterSpacing:"0.09em",textTransform:"uppercase"}},"Any language Â· Any currency")
    )
  );
}
ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
</script>
</body>
</html>
